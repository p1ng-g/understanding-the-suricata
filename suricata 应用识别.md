# 1 数据结构设计
该图主要是模式串检测应用的数据结构设计，端口和预期表比较简单所以未画图。
![](./contents/images/suricata-协议识别和解码.drawio%201.png)
# 2 概览
应用识别主要分为3大步，**初始化，运行，注销。**

对于多模匹配，规则按照传输层协议和方向进行分组，分组可以提高规则匹配效率。

## 2.1 初始化
### 2.2 注册
1. 注册多模匹配表
2. 注册单模匹配表

注册不同多模匹配算法的MpmTableElmt结构，用全局数组mpm_table保存，通过算法对应的ID来调用对应的结构。单模匹配同理，单模匹配的全局数组是spm_table。

### 2.2 设置
1. 设置单模匹配的线程上下文
2. 设置多模匹配上下文
3. 注册应用层协议的识别规则
4. 应用识别准备：
    1. 设置模式串id，模式串去重
    2. 把模式串添加到哈希表
    3. 编译模式串

## 2.2 运行
解码和流重组完成之后，应用数据需要推送到应用层，首先要进行应用层协议识别，然后推送到应用层协议解码器做协议解析。

根据已知的信息（包括传输层协议，方向等），可以通过预先注册和设置的全局变量，找到对应的规则和匹配工具进行规则匹配。

首先进行多摸匹配，快速从大量模式串中筛选出候选规则，然后逐条进行精确的单模匹配，确认命中的规则。（这样子同一条模式串是不是会匹配两次，多模一次，单模一次？可以避免吗？）

# 3 识别方法
支持三种识别方法，端口，模式串，预期表。

端口：初始化时注册协议端口，端口以链表的形式组织，匹配时遍历链表，因为基于端口的协议不多，不超过50种，遍历的性能影响不大。

模式串：可以使用hyperscan，ac等多种多模匹配算法，一般是先进行多模匹配过滤出少量候选规则，然后逐项检查完成精确化匹配确定匹配结果。

预期表：我不知道该怎么翻译，代码中用expectation表示，主要用到了storage工具函数接口，他提供了一种保存状态的能力，保存的状态是后续检测的必要条件，常用于FTP这样控制数据分离的协议识别。FTP的控制会话回指定数据会话使用的端口，保存控制会话的状态是识别FTP数据的必要条件。
